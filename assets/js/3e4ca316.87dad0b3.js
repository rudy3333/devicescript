"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2671],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(n),m=i,f=d["".concat(l,".").concat(m)]||d[m]||u[m]||r;return n?a.createElement(f,s(s({ref:t},c),{},{components:n})):a.createElement(f,s({ref:t},c))}));function f(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[d]="string"==typeof e?e:i,s[1]=o;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},60979:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(25773),i=(n(27378),n(35318));const r={title:"Runtime implementation",sidebar_position:99},s="Runtime implementation",o={unversionedId:"language/runtime",id:"language/runtime",title:"Runtime implementation",description:"DeviceScript compiler takes TypeScript files and generates bytecode files, which are then executed by",source:"@site/docs/language/runtime.mdx",sourceDirName:"language",slug:"/language/runtime",permalink:"/devicescript/language/runtime",draft:!1,tags:[],version:"current",sidebarPosition:99,frontMatter:{title:"Runtime implementation",sidebar_position:99},sidebar:"tutorialSidebar",previous:{title:"Tree-shaking",permalink:"/devicescript/language/tree-shaking"},next:{title:"Bytecode",permalink:"/devicescript/language/bytecode"}},l={},p=[{value:"Memory requirements",id:"memory",level:2},{value:"Why not Web Assembly (Wasm)?",id:"why-not-web-assembly-wasm",level:2},{value:"NaN-boxing",id:"nan-boxing",level:2},{value:"String representation",id:"string-representation",level:2},{value:"GC",id:"gc",level:2},{value:"Bytecode example",id:"bytecode-example",level:2}],c={toc:p},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"runtime-implementation"},"Runtime implementation"),(0,i.kt)("p",null,"DeviceScript compiler takes TypeScript files and generates bytecode files, which are then executed by\nthe DeviceScript runtime.\nThe bytecode files are designed to be small (about half the size of source code)\nand executable directly from storage (typically flash memory), with minimal overhead in RAM."),(0,i.kt)("p",null,"For technical specification of bytecode files see ",(0,i.kt)("a",{parentName:"p",href:"/language/bytecode"},"Bytecode format page"),"\nand the example below."),(0,i.kt)("h2",{id:"memory"},"Memory requirements"),(0,i.kt)("p",null,"A DeviceScript build for Raspberry Pi Pico (not W) takes about 200kB of flash.\nOf that, 134kB is taken by DeviceScript (and Jacdac) library and the rest by system libraries.\nA build for STM32L4+ takes 153kB of flash, of which 115kB if taken by DeviceScript\n(this likely due to different compiler settings).\nBuilds for ESP32 are around 1.2MB due to various libraries, mostly related to networking and TLS."),(0,i.kt)("p",null,"These numbers do not include bytecode size for user program."),(0,i.kt)("p",null,"RAM usage can be configured via ",(0,i.kt)("inlineCode",{parentName:"p"},"JD_GC_KB"),". This defaults to 64kB but it's often possible\nto run with 32kB or less when not doing web requests.\nAdditionally, the following subsystems take some RAM:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"DeviceScript context - 2kB"),(0,i.kt)("li",{parentName:"ul"},"DeviceScript logging (",(0,i.kt)("inlineCode",{parentName:"li"},"DMESG()"),") - 4kB"),(0,i.kt)("li",{parentName:"ul"},"Jacdac packet queues - 5kB")),(0,i.kt)("p",null,"Note that networking typically takes significant amounts of RAM, especially when using TLS."),(0,i.kt)("h2",{id:"why-not-web-assembly-wasm"},"Why not Web Assembly (Wasm)?"),(0,i.kt)("p",null,"While the DeviceScript runtime itself can be compiled to Wasm, the bytecode format that the TypeScript\nis compiled to is quite different."),(0,i.kt)("p",null,"Wasm files have a tree structure of unlimited depth, designed for fast JIT compilation, not in-place interpreters.\nThus, executing Wasm from a read-only memory incurs significant overhead in working memory,\neven with ",(0,i.kt)("a",{parentName:"p",href:"https://arxiv.org/pdf/2205.01183.pdf"},"state of the art approaches"),".\nTypically, on an embedded system you have ~5x-20x the flash memory (which is quite slow to write) compared to RAM."),(0,i.kt)("p",null,"Additionally, Wasm is a low-level bytecode, for example ",(0,i.kt)("inlineCode",{parentName:"p"},"i32.add")," takes two 32-bit integers and adds them up.\nFor JavaScript semantics, you want the ",(0,i.kt)("inlineCode",{parentName:"p"},"+")," operator to work on doubles, strings, and integers (if represented differently than doubles)."),(0,i.kt)("h2",{id:"nan-boxing"},"NaN-boxing"),(0,i.kt)("p",null,"The DeviceScript runtime uses ",(0,i.kt)("a",{parentName:"p",href:"https://anniecherkaev.com/the-secret-life-of-nan"},"NaN-boxing"),"\non both 64- and 32-bit architectures.\nThat is all JavaScript values are represented as 64-bit doubles,\nbut various NaN and subnormal encodings have special meaning:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"all 32-bit signed integers are represented in low word (mantissa),\nwhen the high word (sign, exponent, and high bits of mantissa) is set to ",(0,i.kt)("inlineCode",{parentName:"li"},"0xffff_ffff"),"\n(this is a subset of NaNs)"),(0,i.kt)("li",{parentName:"ul"},"various special values (",(0,i.kt)("inlineCode",{parentName:"li"},"undefined"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"NaN"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"true"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Infinity"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"-Infinity"),")\nare represented as subnormals"),(0,i.kt)("li",{parentName:"ul"},"pointers to heap objects are also represented as subnormals;\non 64-bit machines pointers are assumed to live within GC heap, which is assumed to be under 4GB"),(0,i.kt)("li",{parentName:"ul"},"references to bytecode objects (strings, buffers, service specifcations, functions, ...)\nare subnormal too"),(0,i.kt)("li",{parentName:"ul"},"finally, functions (which are 16 bit indices) can be bound to other objects and still fit in a subnormal;\nthat is, ",(0,i.kt)("inlineCode",{parentName:"li"},"x.foo")," where ",(0,i.kt)("inlineCode",{parentName:"li"},".foo")," is a function is represented as heap reference to ",(0,i.kt)("inlineCode",{parentName:"li"},"x")," and index of ",(0,i.kt)("inlineCode",{parentName:"li"},".foo")," function\nin bytecode, all packed into a 64-bit value")),(0,i.kt)("h2",{id:"string-representation"},"String representation"),(0,i.kt)("p",null,"All strings are represented as valid UTF8 (which is a ",(0,i.kt)("a",{parentName:"p",href:"/language/strings"},"slight departure")," from JavaScript semantics).\nThis makes it easy to send them over wire and also saves memory when strings only use\nASCII characters (which is often the case even in international code-bases due to field/function names).\nThere are two representations:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"short ASCII strings are represented simply as NUL-terminated byte sequences in bytecode - when ",(0,i.kt)("inlineCode",{parentName:"li"},".length")," is requested - it's recomputed"),(0,i.kt)("li",{parentName:"ul"},"longer and non-ASCII strings are represented as structures with byte size, character length and jump list to speed up indexing;\nthe jump list has byte index of every 16-th character index")),(0,i.kt)("h2",{id:"gc"},"GC"),(0,i.kt)("p",null,"Garbage collector in DeviceScript is quite simple, yet efficient.\nCollection can happen on any allocation, and is forced after a fixed size of allocations has been reached since\nlast collection, or when the allocation cannot be performed.\nAllocation always prefers returning smaller addresses, which tends to reduce fragmentation\n(this is also the reason why we force collection more often than necessary)."),(0,i.kt)("p",null,"The collection is quick, since the heap size compared to CPU speed is very small.\nTypical embedded system is 10x-100x slower than a desktop CPU, but has 100,000x-1,000,000x less RAM,\nthus scanning the whole heap takes on the order of a single millisecond."),(0,i.kt)("h2",{id:"bytecode-example"},"Bytecode example"),(0,i.kt)("p",null,"Let's take a look at how a simple example is compiled:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'function add(x: any, y: any) {\n    return x + y\n}\nfunction assertEq(x: any, y: any) {\n    if (x !== y) throw new Error(`Not eq: ${x} != ${y}!`)\n}\nassertEq(add(2, 2.1), 4.1)\nassertEq(add("2", 2), "22")\n')),(0,i.kt)("p",null,"We compile it with ",(0,i.kt)("inlineCode",{parentName:"p"},"devs build")," and then can disassemble it with ",(0,i.kt)("inlineCode",{parentName:"p"},"devs disasm"),"\n(or ",(0,i.kt)("inlineCode",{parentName:"p"},"devs disasm --detailed"),"; you can also pass a ",(0,i.kt)("inlineCode",{parentName:"p"},".devs")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"-dbg.json")," file to ",(0,i.kt)("inlineCode",{parentName:"p"},"disasm"),").\nThe disassembly results in the following output:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"proc main_F0(): @176\n")),(0,i.kt)("p",null,"The first procedure in bytecode file is an entry point.\nHere, it sits at byte offset ",(0,i.kt)("inlineCode",{parentName:"p"},"176")," in the bytecode file."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"   0:     CALL prototype_F1{F1}() // 270102\n")),(0,i.kt)("p",null,"The three bytes ",(0,i.kt)("inlineCode",{parentName:"p"},"0x27, 0x01, 0x02"),' encode state\n"function reference", "function number 1", "call 0-arguments".'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"   3:     CALL add_F3{F3}(2, 2.1{D0}) // 270392290004\n")),(0,i.kt)("p",null,'Here the opcodes say "function reference", "function 3",\n"constant 0x92 - 0x90 == 2", "double reference",\n"double number 0", "call 2-arguments".\nThe number ',(0,i.kt)("inlineCode",{parentName:"p"},"3:")," in front refers to byte offset within a function."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"   9:     CALL assertEq_F2{F2}(ret_val(), 4.1{D1}) // 27022c290104\n")),(0,i.kt)("p",null,"Here, we have ",(0,i.kt)("inlineCode",{parentName:"p"},"ret_val()")," opcode refering to the result of previous\ncall - calls are statements so they cannot be nested."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},'  15:     CALL add_F3{F3}("2"{A3}, 2) // 270325039204\n')),(0,i.kt)("p",null,"The new thing here is ASCII string reference (see table of strings and doubles at the bottom of the file)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},'  21:     CALL assertEq_F2{F2}(ret_val(), "22"{A4}) // 27022c250404\n  27:     CALL ds."restart"{I57}() // 1e3902\n  30:     RETURN 0 // 900c\n')),(0,i.kt)("p",null,"The compiler adds call to ",(0,i.kt)("inlineCode",{parentName:"p"},"ds.restart()")," in test-mode compilation.\nNote that there is special opcode for members of ",(0,i.kt)("inlineCode",{parentName:"p"},"@devicescript/core"),'\nmodule that are referenced by built-in strings ("internal string 57");\nthus ',(0,i.kt)("inlineCode",{parentName:"p"},"ds.restart()")," is only 3 bytes.\nThe final ",(0,i.kt)("inlineCode",{parentName:"p"},"RETURN")," is superfluous."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"proc prototype_F1(): @208\n   0:     RETURN undefined // 2e0c\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"prototype_Fx()")," function would have assignment of methods\nto prototypes if there were any.\nAlso ",(0,i.kt)("inlineCode",{parentName:"p"},"undefined")," has it's own opcode."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"proc assertEq_F2(par0, par1): @212\n   0:     JMP 25 IF NOT (par0{L0} !== par1{L1}) // 15001501470ef90014\n")),(0,i.kt)("p",null,"Here we jump to offset ",(0,i.kt)("inlineCode",{parentName:"p"},"25"),' if the condition is not true.\nThe condition refers to "local variable 0" and "1"\n(which happen to be parameters).'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},'   9:     CALL ds."format"{I76}("Not eq: {0} != {1}!"{A1}, par0{L0}, par1{L1}) // 1e4c25011500150105\n')),(0,i.kt)("p",null,"The template literals are compiled to ",(0,i.kt)("inlineCode",{parentName:"p"},"ds.format()")," calls."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"  18:     CALL (new Error{O27})(ret_val()) // 011b582c03\n")),(0,i.kt)("p",null,"Here, the ",(0,i.kt)("inlineCode",{parentName:"p"},"new"),' opcode takes a reference to "built-in object 27" (',(0,i.kt)("inlineCode",{parentName:"p"},"Error"),")."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},"  23:     THROW ret_val() // 2c54\n  25:     RETURN undefined // 2e0c\n\nproc add_F3(par0, par1): @240\n   0:     RETURN (par0{L0} + par1{L1}) // 150015013a0c\n\n")),(0,i.kt)("p",null,"Note how the ",(0,i.kt)("inlineCode",{parentName:"p"},"+")," opcode can be used on both strings and numbers."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:"skip",skip:!0},'Strings ASCII:\n   0: "assertEq"\n   1: "Not eq: {0} != {1}!"\n   2: "add"\n   3: "2"\n   4: "22"\n   5: "assertEq"\n\nStrings UTF8:\n\nStrings buffer:\n\nDoubles:\n   0: 2.1\n   1: 4.1\n')),(0,i.kt)("p",null,"The file finishes with tables of various literals.\nThe short ASCII literals are separate from UTF8 literals, which have a more\ncomplex representation."))}u.isMDXComponent=!0}}]);